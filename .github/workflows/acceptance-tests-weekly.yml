# Runs acceptance tests against a real Jamf Pro instance every Sunday.
# Requires repository secrets: INSTANCE_DOMAIN, AUTH_METHOD, and either
# (CLIENT_ID + CLIENT_SECRET) for OAuth2 or (BASIC_AUTH_USERNAME + BASIC_AUTH_PASSWORD).
name: Acceptance Tests (Weekly)

on:
  schedule:
    # 00:00 UTC every Sunday
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  acceptance-tests:
    name: 'ðŸ§ª Acceptance Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      INSTANCE_DOMAIN: ${{ secrets.INSTANCE_DOMAIN }}
      AUTH_METHOD: ${{ secrets.AUTH_METHOD }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      BASIC_AUTH_USERNAME: ${{ secrets.BASIC_AUTH_USERNAME }}
      BASIC_AUTH_PASSWORD: ${{ secrets.BASIC_AUTH_PASSWORD }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: 'go.sum'
          cache: true

      - name: Run acceptance tests
        run: go test -v -count=1 ./jamfpro/acceptance/...
