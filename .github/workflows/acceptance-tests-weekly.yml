# Runs unit tests then acceptance tests against a real Jamf Pro instance every Sunday.
name: go | Weekly Tests

on:
  schedule:
    # 00:00 UTC every Sunday
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  unit-tests:
    name: 'ðŸ§ª Unit Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: 'go.sum'
          cache: true

      - name: Run unit tests (with coverage)
        run: |
          go test -coverprofile=coverage.out -covermode=atomic \
            $(go list ./... | grep -v '/acceptance')
        env:
          CGO_ENABLED: '0'

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.2.0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: deploymenttheory/go-sdk-jamfpro-v2
          files: coverage.out

  acceptance-tests:
    name: 'ðŸ§ª Acceptance Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: unit-tests
    env:
      INSTANCE_DOMAIN: ${{ secrets.INSTANCE_DOMAIN }}
      AUTH_METHOD: ${{ secrets.AUTH_METHOD }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: 'go.sum'
          cache: true

      - name: Run acceptance tests (with coverage)
        run: go test -v -count=1 -coverprofile=acceptance_coverage.out -covermode=atomic ./jamfpro/acceptance/...

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.2.0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: deploymenttheory/go-sdk-jamfpro-v2
          files: acceptance_coverage.out
